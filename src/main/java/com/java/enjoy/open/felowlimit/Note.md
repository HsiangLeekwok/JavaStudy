## 限流

### 计数器方式

### 令牌桶算法

#### 场景

- 系统每秒向桶里放入 5 个令牌
- 桶的容量是5，如果桶已经满了，那么令牌被丢弃
- 系统处理请求时，需先从令牌桶中拿一个令牌，然后进行处理
- 如果令牌桶中没有令牌，则进行限流

#### 特点

- 没有临界问题
- 缓冲区：比如桶中已经有5个令牌，第一秒可处理的最大请求数量为 10 个（桶中 5 个 + 1s 生成 5 个），后续请求会限制在每秒 5 个
- 允许冲突：允许一次请求多个令牌

#### 限流的层面

应用层限流(接口层 Controller)

#### 开源框架

Guava框架中的RateLimiter类

#### 分布式限流的难点

- 应用部署有多台，需要进行全局限流
- 负载均衡不一定能够“雨露均沾”

#### 关键解决方案

- 一个全局的计数器或者令牌桶
- 把限流处理做成原子化

##### 全局计数器——Redis

- 基于键值对(key-value)的内存数据库
- 提供键过期机制(限制时间)
- 单线程模型

##### 实现方案

- 京东的部分业务就是使用 Redis + Lua 实现限流
- 优雅的实现可以使用 AOP 方式
- 实际问题实际分析，要考虑成本